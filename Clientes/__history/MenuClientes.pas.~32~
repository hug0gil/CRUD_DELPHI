unit MenuClientes;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, MenuBase, Data.DB, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  FireDAC.Comp.Client, FireDAC.Comp.DataSet, Vcl.Buttons, Vcl.DBCtrls,
  Vcl.Grids, Vcl.DBGrids, Vcl.StdCtrls, Vcl.ExtCtrls, FichaClientes,
  ModuloDatos;

type
  TFormMenuClientes = class(TFormMenuBase)
    FDTableNCODIGO: TIntegerField;
    FDTableDFECHA_ULT_VENTA: TDateField;
    FDTableCNOMBRE: TStringField;
    FDTableREG_FISCAL: TStringField;
    FDTableNOMBRE_REGIMEN: TStringField;
    procedure btnAgregarClick(Sender: TObject);
    procedure OnCreate(Sender: TObject);
    procedure FDTableCalcFields(DataSet: TDataSet);
    procedure btnActualizarClick(Sender: TObject);
    procedure btnVerClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FormMenuClientes: TFormMenuClientes;

implementation

{$R *.dfm}

procedure TFormMenuClientes.btnActualizarClick(Sender: TObject);
var
  FormUpdateClientes: TFormFichaClientes;
begin
  FormUpdateClientes := TFormFichaClientes.Create(Self, UltimoCodigo, 1);
  FormUpdateClientes.Caption := 'Actualizar';
  FormUpdateClientes.lblTitulo.Caption := 'Actualizar el cliente seleccionado';
  FormUpdateClientes.ShowModal;
  FormUpdateClientes.Free;
end;

procedure TFormMenuClientes.btnAgregarClick(Sender: TObject);
var
  FormAddClientes: TFormFichaClientes;
begin
  FormAddClientes := TFormFichaClientes.Create(Self, UltimoCodigo, 1);
  FormAddClientes.Caption := 'Añadir';
  FormAddClientes.lblTitulo.Caption := 'Agregar nuevo cliente';
  FormAddClientes.ShowModal;
  FormAddClientes.Free;
end;

procedure TFormMenuClientes.btnVerClick(Sender: TObject);
var
  FormAddClientes: TFormFichaClientes;
begin
  FormAddClientes := TFormFichaClientes.Create(Self, UltimoCodigo, 1);
  FormAddClientes.Caption := 'Añadir';
  FormAddClientes.lblTitulo.Caption := 'Agregar nuevo cliente';
  FormAddClientes.ShowModal;
  FormAddClientes.Free;
end;

procedure TFormMenuClientes.FDTableCalcFields(DataSet: TDataSet);
begin
  case DataSet.FieldByName('CREG_FISCAL').AsString[1] of
    'E':
      DataSet.FieldByName('NOMBRE_REGIMEN').AsString := 'Exento';
    'N':
      DataSet.FieldByName('NOMBRE_REGIMEN').AsString := 'Normal';
    'R':
      DataSet.FieldByName('NOMBRE_REGIMEN').AsString := 'Recargo';
    'I':
      DataSet.FieldByName('NOMBRE_REGIMEN').AsString := 'Internacional';
    'X':
      DataSet.FieldByName('NOMBRE_REGIMEN').AsString := 'Extranjero';
    'G':
      DataSet.FieldByName('NOMBRE_REGIMEN').AsString := 'Canarias'
  end;

end;

procedure TFormMenuClientes.OnCreate(Sender: TObject);
begin
  UltimoCodigo := GetLastCodigo('NCODIGO', 'CLIENTES');
  if not ModuloDatos.DataModuleBDD.FDTransaction.Active then
    ModuloDatos.DataModuleBDD.FDTransaction.StartTransaction;

  if not DataSource.DataSet.Active then
    DataSource.DataSet.Open;

  if not(DataSource.DataSet.State in [dsEdit, dsInsert]) then
    DataSource.DataSet.Edit;

  DBNavigator.Enabled := True;
end;

end.
