unit MenuBase;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Vcl.ExtCtrls, Vcl.Buttons,
  Vcl.DBCtrls, Vcl.Grids, Vcl.DBGrids, Vcl.StdCtrls, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client, ModuloDatos;

type
  TFormMenuBase = class(TForm)
    Panel1: TPanel;
    btnActualizar: TButton;
    btnAgregar: TButton;
    Shape1: TShape;
    Panel2: TPanel;
    DBGrid: TDBGrid;
    DBNavigator: TDBNavigator;
    btnEliminar: TButton;
    btnVer: TButton;
    FDTable: TFDTable;
    DataSource: TDataSource;
    FDTransactionTable: TFDTransaction;
    procedure DBNavigatorClick(Sender: TObject; Button: TNavigateBtn);
    function GetLastCodigo(const PrimaryKey: String;
      const TableName: String): String;
    procedure FormActivate(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    UltimoCodigo: Integer;
  end;

implementation

{$R *.dfm}

function TFormMenuBase.GetLastCodigo(const PrimaryKey: String;
  const TableName: String): String;
var
  FDQuery: TFDQuery;
begin
  FDQuery := TFDQuery.Create(nil);
  try
    FDQuery.Connection := ModuloDatos.DataModuleBDD.DataBaseFDConnection;
    FDQuery.SQL.Text := 'SELECT MAX(' + PrimaryKey + ') FROM ' + TableName;
    FDQuery.Open;

    if FDQuery.Fields[0].IsNull then
      Result := IntToStr(1) // Corregido: Convertimos 1 a string
    else
      Result := IntToStr(FDQuery.Fields[0].AsInteger + 1); // Convertimos siempre a string
  finally
    FDQuery.Free;
  end;
end;

procedure TFormMenuBase.DBNavigatorClick(Sender: TObject; Button: TNavigateBtn);
begin
  case Button of
    nbPost:
      begin
        if not FDTransactionTable.Active then
          FDTransactionTable.StartTransaction;

        if FDTable.State in [dsEdit, dsInsert] then
          FDTable.Post;

        if FDTransactionTable.Active then
          FDTransactionTable.Commit;
      end;

    nbCancel:
      begin
        if not FDTransactionTable.Active then
          FDTransactionTable.StartTransaction;

        if FDTable.State in [dsEdit, dsInsert] then
          FDTable.Cancel;

        if FDTransactionTable.Active then
          FDTransactionTable.Rollback;
      end;
  end;
end;

procedure TFormMenuBase.FormActivate(Sender: TObject);
begin
  FDTransactionTable.StartTransaction;

end;

end.
